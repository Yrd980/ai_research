name: Sync Markdown/CSV To Feishu

on:
  push:
    branches:
      - main
    paths:
      - "docs/**/*.md"
      - "data/**/*.csv"
      - "sync/feishu_sync_targets.json"
      - "scripts/feishu_sync.py"
      - "requirements-feishu-sync.txt"
      - ".github/workflows/sync-to-feishu.yml"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements-feishu-sync.txt

      - name: Sync to Feishu
        env:
          FEISHU_APP_ID: ${{ vars.FEISHU_APP_ID || secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_BASE_URL: ${{ vars.FEISHU_BASE_URL }}
        run: |
          set -e
          MODE="changed"
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="all"
            BASE_SHA=""
          fi

          python scripts/feishu_sync.py \
            --config sync/feishu_sync_targets.json \
            --mode "$MODE" \
            --base-sha "$BASE_SHA" \
            --head-sha "$HEAD_SHA"
